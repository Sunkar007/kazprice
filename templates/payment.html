{% extends 'base.html' %}

{% block title %}Төлем — KazPrice{% endblock %}

{% block content %}
  <div class="py-4">
    <div class="container">
      <h3 class="mb-4">Төлем әдісін таңдаңыз</h3>

      <div class="row">
        <div class="col-12 col-lg-8">
          <!-- Payment Methods -->
          <div class="card p-4 mb-4">
            <h5 class="mb-4">Сақталған карталар</h5>
            
            {% if cards %}
              <form id="paymentForm">
                {% for card in cards %}
                <div class="card mb-3 p-3 border-2" id="card-{{ card.id }}">
                  <div class="form-check">
                    <input class="form-check-input" type="radio" name="card_id" id="card_{{ card.id }}" 
                           value="{{ card.id }}" {% if loop.first %}checked{% endif %} 
                           data-balance="{{ card.balance }}" data-card-number="{{ card.card_number }}">
                    <label class="form-check-label w-100" for="card_{{ card.id }}">
                      <div class="d-flex justify-content-between align-items-center">
                        <div>
                          <strong>{{ card.card_name }}</strong>
                          <div class="text-muted small">Нөмір: {{ card.card_number }}</div>
                          <div class="text-muted small">Қолданылуы мүмкін: <span class="text-success">{{ '{:,.0f}'.format(card.balance) }}</span> ₸</div>
                        </div>
                      </div>
                    </label>
                  </div>
                </div>
                {% endfor %}
              </form>
            {% else %}
              <div class="alert alert-warning" role="alert">
                Сақталған карталар жоқ. <a href="{{ url_for('profile') }}">Картаны қосу</a>
              </div>
            {% endif %}
          </div>

          <!-- Payment Info -->
          <div class="card p-4 mb-4 bg-light">
            <h5 class="mb-3">Төлем мәліметтері:</h5>
            <div class="d-flex justify-content-between mb-2">
              <span>Тауарлар:</span>
              <span id="paymentSubtotal">{{ '{:,.0f}'.format(cart_total) }}</span> ₸
            </div>
            <div class="d-flex justify-content-between mb-3 pb-3 border-bottom">
              <span>Жеткізу:</span>
              <span id="paymentDelivery">{{ '{:,.0f}'.format(delivery_cost) }}</span> ₸
            </div>
            <div class="d-flex justify-content-between">
              <h5 class="mb-0">Төленетін алпы сомма:</h5>
              <h5 class="mb-0"><span id="paymentTotal">{{ '{:,.0f}'.format(total_amount) }}</span> ₸</h5>
            </div>
          </div>
        </div>

        <!-- Order Summary & Pay Button -->
        <aside class="col-12 col-lg-4">
          <div class="card p-4 sticky-top" style="top: 20px;">
            <h5 class="mb-4">Тапсырыс мазмұны</h5>
            
            <div class="mb-3">
              <small class="text-muted d-block mb-2">Таңдалған карта:</small>
              <span id="selectedCard" class="badge bg-primary">Картаны таңдаңыз</span>
            </div>

            <div class="alert alert-info small" id="balanceWarning" style="display:none;">
              ⚠️ Таңдалған картада жеткілікті қаражат жоқ.
            </div>

            <div class="d-grid gap-2">
              <button id="payButton" class="btn btn-success btn-lg" disabled>
                <span id="payButtonText">Төлеу</span>
              </button>
              <a href="{{ url_for('checkout') }}" class="btn btn-outline-secondary">Артқа</a>
            </div>

            <small class="text-muted mt-3 d-block">
              Төлем құрылымы арқылы өңделеді. Сіздің картаңыз көрсетілген.
            </small>
          </div>
        </aside>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function(){
      const totalAmount = Number({{ total_amount }});
      const payForm = document.getElementById('paymentForm');
      const payButton = document.getElementById('payButton');
      const selectedCardSpan = document.getElementById('selectedCard');
      const balanceWarning = document.getElementById('balanceWarning');

      // Ensure pay button starts disabled
      if(payButton) payButton.disabled = true;

      if(!payForm){
        // No saved cards — keep pay button disabled
        return;
      }

      // Delegate change events for radio inputs (robust for dynamic content)
      payForm.addEventListener('change', function(e){
        const target = e.target;
        if(!target || target.name !== 'card_id') return;

        const selected = payForm.querySelector('input[name="card_id"]:checked');
        if(!selected){
          if(payButton) payButton.disabled = true;
          selectedCardSpan.textContent = 'Картаны таңдаңыз';
          balanceWarning.style.display = 'none';
          return;
        }

        const balance = Number(selected.dataset.balance || 0);
        const cardNameElem = selected.closest('.card') ? selected.closest('.card').querySelector('strong') : null;
        const cardName = cardNameElem ? cardNameElem.textContent : 'Карта';
        const cardNumber = selected.dataset.cardNumber || '';

        selectedCardSpan.textContent = cardName + (cardNumber ? ' ' + cardNumber : '');

        if(isNaN(balance) || balance < totalAmount){
          balanceWarning.style.display = 'block';
          if(payButton) payButton.disabled = true;
        } else {
          balanceWarning.style.display = 'none';
          if(payButton) payButton.disabled = false;
        }
      });

      // Initial selection check
      const initial = payForm.querySelector('input[name="card_id"]:checked');
      if(initial){
        // Manually trigger handler logic by dispatching a native event
        initial.dispatchEvent(new Event('change', { bubbles: true }));
      }

      // Handle payment submission safely
      if(payButton){
        payButton.addEventListener('click', function(e){
          e.preventDefault();
          const selected = payForm.querySelector('input[name="card_id"]:checked');
          if(!selected){
            alert('Картаны таңдаңыз');
            return;
          }

          const balance = Number(selected.dataset.balance || 0);
          if(isNaN(balance) || balance < totalAmount){
            alert('Таңдалған картада жеткіліксіз қаражат');
            return;
          }

          const cardId = selected.value;
          payButton.disabled = true;
          const originalText = document.getElementById('payButtonText').textContent;
          document.getElementById('payButtonText').textContent = 'Өңделуде...';

          fetch('/process_payment', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({card_id: cardId})
          })
          .then(r => r.json())
          .then(data => {
            if(data.status === 'success'){
              alert(data.message);
              window.location.href = '{{ url_for("main") }}';
            } else {
              alert('Қате: ' + (data.message || 'Төлем сәтсіз'));
              payButton.disabled = false;
              document.getElementById('payButtonText').textContent = originalText;
            }
          })
          .catch(err => {
            console.error(err);
            alert('Төлем сәтсіз');
            payButton.disabled = false;
            document.getElementById('payButtonText').textContent = originalText;
          });
        });
      }
    });
  </script>
{% endblock %}
